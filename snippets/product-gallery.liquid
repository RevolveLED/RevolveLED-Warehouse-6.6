{%- if product.media.size > 0 -%}
  {%- assign show_thumbnails_if_one_media = true -%}

  <div class="product-gallery">
    <div class="product-gallery__inner product-gallery--bottom-thumbnails {% if show_thumbnails_if_one_media %}product-gallery--with-thumbnails{% endif %} {% if template != 'product.quick-view' and section.settings.enable_image_zoom %}product-gallery__carousel--zoomable{% endif %}">
      {%- assign selected_media = product.selected_variant.featured_media | default: product.featured_media -%}

      <div class="product-gallery__carousel-wrapper">
        {%- render 'product-new-tag', product: product -%}
        <div
          class="product-gallery__carousel"
          data-media-count="{{ product.media.size }}"
          data-initial-media-id="{{ selected_media.id }}"
        >
          {%- for media in product.media -%}
            {%- assign is_media_group = false -%}
            {%- assign is_media_filtered = false -%}
            {%- assign media_alt = media.alt -%}

            {%- if media.alt contains '#' -%}
              {%- assign is_media_group = true -%}
              {%- assign alt_parts = media.alt | split: '#' -%}

              {%- comment -%}
                If the custom ALT tag contains two parts (for instance "My custom alt # color_blue") then the first part is actually used
                as a custom ALT tag
              {%- endcomment -%}

              {%- if alt_parts.size == 2 and alt_parts.first != blank -%}
                {%- assign media_alt = alt_parts.first | strip -%}
              {%- else -%}
                {%- assign media_alt = product.title -%}
              {%- endif -%}

              {%- assign media_group_parts = alt_parts.last | split: '_' -%}

              {%- for option in product.options -%}
                {%- assign downcase_option = option | downcase -%}
                {%- assign downcase_group_option = media_group_parts.first | strip | downcase -%}

                {%- if downcase_option == downcase_group_option -%}
                  {%- assign option_setting = 'option' | append: forloop.index -%}
                  {%- assign option_value = product.selected_or_first_available_variant[option_setting] | downcase -%}

                  {%- assign downcase_group_value = media_group_parts.last | strip | downcase -%}
                  {%- assign media_variant_ids = media.variants | map: 'id' -%}

                  {%- if option_value != downcase_group_value -%}
                    {%- unless media_variant_ids contains product.selected_or_first_available_variant.id -%}
                      {%- assign is_media_filtered = true -%}
                    {%- endunless -%}
                  {%- endif -%}

                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}

            <div
              class="product-gallery__carousel-item {% if media.id == selected_media.id %}is-selected{% endif %} {% if is_media_filtered %}is-filtered{% endif %}"
              tabindex="-1"
              data-media-id="{{ media.id }}"
              data-media-type="{{ media.media_type | escape }}"
              {% if media.media_type == 'external_video' %}
                data-media-host="{{ media.host | escape }}" data-video-id="{{ media.external_id | escape }}"
              {% endif %}
              {% if is_media_group %}
                data-group-name="{{ media_group_parts.first | strip | downcase | escape }}"
                data-group-value="{{ media_group_parts.last | strip | downcase | escape }}"
              {% endif %}
            >
              {%- case media.media_type -%}
                {%- when 'image' -%}
                  <div class="product-gallery__size-limiter" style="max-width: {{ media.width }}px">
                    {%- assign data_zoom_url = media | image_url: width: 1800 -%}
                    {%- assign data_zoom_width = 1800 | at_most: media.width -%}

                    <div class="aspect-ratio" style="padding-bottom: {{ 100.0 | divided_by: media.aspect_ratio }}%">
                      {{-
                        media
                        | image_url: width: media.width
                        | image_tag:
                          loading: 'lazy',
                          widths: '400,500,600,700,800,900,1000,1100,1200',
                          class: 'product-gallery__image',
                          data-zoom: data_zoom_url,
                          data-zoom-width: data_zoom_width
                      -}}
                    </div>
                  </div>

                {%- when 'model' -%}
                  <div class="product-gallery__model">
                    <div class="model-wrapper">
                      {{- media | model_viewer_tag: image_size: '1024x', reveal: 'interaction', toggleable: true -}}
                    </div>
                  </div>

                {%- when 'external_video' -%}
                  <div class="product-gallery__external-video">
                    <div class="video-wrapper">
                      {{-
                        media
                        | external_video_tag: image_size: '1024x', loop: section.settings.enable_video_looping
                      -}}
                    </div>
                  </div>

                {%- when 'video' -%}
                  <div class="product-gallery__video">
                    <div
                      class="video-wrapper video-wrapper--native"
                      style="padding-bottom: {{ 100.0 | divided_by: media.aspect_ratio }}%"
                    >
                      {{- media | video_tag: image_size: '1024x', controls: true -}}
                    </div>
                  </div>
              {%- endcase -%}
            </div>
          {%- endfor -%}
        </div>

        {%- comment -%}Add the "view in your space" button, which allows to show the product in customer's environment (if the device supports it){%- endcomment -%}
        {%- assign first_3d_model = product.media | where: 'media_type', 'model' | first -%}

        {%- if first_3d_model -%}
          <button
            class="product-gallery__view-in-space button button--full"
            data-shopify-xr
            data-shopify-model3d-id="{{ first_3d_model.id }}"
            data-shopify-model3d-default-id="{{ first_3d_model.id }}"
            data-shopify-title="{{ product.title | escape }}"
            data-shopify-xr-hidden
          >
            {%- render 'icon', icon: 'media-view-in-space' -%}
            {{- 'product.general.view_in_space' | t -}}
          </button>
        {%- endif -%}
      </div>

      {%- if template != 'product.quick-view' and section.settings.enable_image_zoom -%}
        <div class="product-gallery__zoom-notice">
          {% render 'icon', icon: 'zoom' %}
          <span class="hidden-pocket">{{ 'product.general.zoom' | t }}</span>
          <span class="hidden-lap-and-up">{{ 'product.general.zoom_mobile' | t }}</span>
        </div>
      {%- endif -%}

      {%- if show_thumbnails_if_one_media -%}
        <div id="Gallery-thumbnail-{{ section.id}}" class="scroller product-gallery__thumbnail-wrapper">
          <button
            type="button"
            class="product-gallery__thumbnail-button slider-button--prev"
            name="previous"
            aria-label="{{ 'general.accessibility.previous' | t }}"
            aria-controls="Gallery-thumbnail-{{ section.id}}"
            tabindex="0"
            aria-disabled="false"
            data-thumbnail-prev
          >
            <svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect width="30" height="30" rx="15" transform="matrix(0 1 1 0 0 0)" fill="currentColor"/>
              <path d="M9.23047 17.3076L14.9997 11.5383L20.7689 17.3076" stroke="white" stroke-width="1.15385" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="scroller__inner product-gallery__thumbnail-list-wrapper">
            <div class="product-gallery__thumbnail-list">
              {%- for media in product.media -%}
                {%- assign is_media_group = false -%}
                {%- assign is_media_filtered = false -%}
                {%- assign media_alt = media.alt -%}

                {%- if media.alt contains '#' -%}
                  {%- assign is_media_group = true -%}
                  {%- assign alt_parts = media.alt | split: '#' -%}

                  {%- comment -%}
                    If the custom ALT tag contains two parts (for instance "My custom alt # color_blue") then the first part is actually used
                    as a custom ALT tag
                  {%- endcomment -%}

                  {%- if alt_parts.size == 2 and alt_parts.first != blank -%}
                    {%- assign media_alt = alt_parts.first | strip -%}
                  {%- else -%}
                    {%- assign media_alt = product.title -%}
                  {%- endif -%}

                  {%- assign media_group_parts = alt_parts.last | split: '_' -%}

                  {%- for option in product.options -%}
                    {%- assign downcase_option = option | downcase -%}
                    {%- assign downcase_group_option = media_group_parts.first | strip | downcase -%}

                    {%- if downcase_option == downcase_group_option -%}
                      {%- assign option_setting = 'option' | append: forloop.index -%}
                      {%- assign option_value = product.selected_or_first_available_variant[option_setting]
                        | downcase
                      -%}

                      {%- assign downcase_group_value = media_group_parts.last | strip | downcase -%}
                      {%- assign media_variant_ids = media.variants | map: 'id' -%}

                      {%- if option_value != downcase_group_value -%}
                        {%- unless media_variant_ids contains product.selected_or_first_available_variant.id -%}
                          {%- assign is_media_filtered = true -%}
                        {%- endunless -%}
                      {%- endif -%}

                      {%- break -%}
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}

                <a
                  href="{{ media | img_url: '1024x' }}"
                  rel="noopener"
                  class="product-gallery__thumbnail {% if media.id == selected_media.id %}is-nav-selected{% endif %} {% if is_media_filtered %}is-filtered{% endif %}"
                  data-media-id="{{ media.id }}"
                  {% if is_media_group %}
                    data-group-name="{{ media_group_parts.first | strip | downcase | escape }}"
                    data-group-value="{{ media_group_parts.last | strip | downcase | escape }}"
                  {% endif %}
                >
                  {%- comment -%}Based on the type of media, we have to add an icon as per Shopify rules{%- endcomment -%}

                  {%- case media.media_type -%}
                    {%- when 'model' -%}
                      <span class="product-gallery__thumbnail-badge">
                        {%- render 'icon', icon: 'media-model-badge' -%}
                      </span>

                    {%- when 'video', 'external_video' -%}
                      <span class="product-gallery__thumbnail-badge">
                        {%- render 'icon', icon: 'media-video-badge' -%}
                      </span>
                  {%- endcase -%}

                  {{-
                    media
                    | image_url: width: media.width
                    | image_tag: loading: 'lazy', sizes: '130px', widths: '130,260,390'
                  -}}
                </a>
              {%- endfor -%}
            </div>
          </div>
          <button
            type="button"
            class="product-gallery__thumbnail-button slider-button--next"
            name="next"
            aria-label="{{ 'general.accessibility.next' | t }}"
            aria-controls="Gallery-thumbnail-{{ section.id}}"
            tabindex="0"
            aria-disabled="false"
            data-thumbnail-next
          >
            <svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect width="30" height="30" rx="15" transform="matrix(0 -1 -1 0 30 30)" fill="currentColor"/>
              <path d="M20.7695 12.6924L15.0003 18.4617L9.23107 12.6924" stroke="white" stroke-width="1.15385" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      {%- endif -%}

      {%- if section.settings.enable_image_zoom -%}
        {%- comment -%}This code is used to power the mobile zoom and must not be removed nor altered{%- endcomment -%}
        <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="pswp__bg"></div>
          <div class="pswp__scroll-wrap">
            <div class="pswp__container">
              <div class="pswp__item"></div>
              <div class="pswp__item"></div>
              <div class="pswp__item"></div>
            </div>

            <div class="pswp__ui">
              <button class="pswp__button pswp__button--close" aria-label="{{ 'general.accessibility.close' | t }}">
                {% render 'icon', icon: 'close-2' %}
              </button>

              <div class="pswp__prev-next">
                <button
                  class="pswp__button pswp__button--arrow--left"
                  aria-label="{{ 'general.accessibility.previous' | t }}"
                >
                  {% render 'icon', icon: 'arrow-left' %}
                </button>

                <button
                  class="pswp__button pswp__button--arrow--right"
                  aria-label="{{ 'general.accessibility.next' | t }}"
                >
                  {% render 'icon', icon: 'arrow-right' %}
                </button>
              </div>

              <div class="pswp__pagination">
                <span class="pswp__pagination-current"></span> / <span class="pswp__pagination-count"></span>
              </div>
            </div>
          </div>
        </div>
      {%- endif -%}
    </div>
  </div>
{%- endif -%}
