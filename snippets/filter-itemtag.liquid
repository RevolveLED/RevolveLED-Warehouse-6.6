{%- capture itemtag -%}{{ tag | append:"_" }}{%- endcapture -%}
{%- capture link_id -%}{{ index | prepend:"filter-" }}{%- endcapture -%}
{% assign all_tags = collection.all_tags %}

{%- comment -%}
  判断该组是否存在符合条件的 tag
{%- endcomment -%}
{% assign has_matching_tag = false %}
{%- for current_tag in all_tags -%}
  {% if current_tag contains itemtag %}
    {% assign has_matching_tag = true %}
    {% break %}
  {% endif %}
{%- endfor -%}

{%- comment -%}
  预先计算该组是否有激活项
{%- endcomment -%}
{% assign has_active_tag_in_group = false %}
{% for current_tag in all_tags %}
  {% assign trimmed_tag = current_tag | strip %}
  {% if trimmed_tag contains itemtag %}
    {% for active_tag in current_tags %}
      {% if active_tag == trimmed_tag %}
        {% assign has_active_tag_in_group = true %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endif %}
  {% if has_active_tag_in_group %}
    {% break %}
  {% endif %}
{% endfor %}

{% if has_matching_tag %}
  {%- capture filter_list_markup -%}
    <ul class="filter-item-list"{% unless has_active_tag_in_group %}style="display: none;"{% endunless %}>
      {% for current_tag in all_tags %}
        {% assign trimmed_tag = current_tag | strip %}
        {% assign is_tag_active = false %}
        {% assign product_count = 0 %}

        {% for active_tag in current_tags %}
          {% if active_tag == trimmed_tag %}
            {% assign is_tag_active = true %}
          {% endif %}
        {% endfor %}

        {% if trimmed_tag contains itemtag %}
          {% for product in collection.products %}
            {% for product_tag in product.tags %}
              {% if product_tag == current_tag %}
                {% assign product_count = product_count | plus: 1 %}
              {% endif %}
            {% endfor %}
          {% endfor %}

          {% if is_tag_active %}
            <li
              class="advanced-filter active-filter"
              data-group="{{ itemtag }}"
              data-handle="{{ trimmed_tag | handleize }}"
            >
              {{
                trimmed_tag
                | prepend: '<span class="tag-close"></span><span>'
                | append: '</span>'
                | link_to_remove_tag: trimmed_tag
                | remove: itemtag
              -}}
              <span class="count">({{ product_count }})</span>
            </li>
          {% else %}
            <li
              class="advanced-filter"
              data-group="{{ itemtag }}"
              data-handle="{{ trimmed_tag | handleize }}"
            >
              {{
                trimmed_tag
                | prepend: '<span class="tag-close"></span><span>'
                | append: '</span>'
                | link_to_add_tag: trimmed_tag
                | remove: itemtag
              -}}
              <span class="count">({{ product_count }})</span>
            </li>
          {% endif %}
        {% endif %}
      {% endfor %}
    </ul>
  {%- endcapture -%}

  <div class="filter-type item{% if has_active_tag_in_group %} active-filter-type{% endif %}">
    <div class="filter-item-title" aria-expanded="{% if has_active_tag_in_group %}true{% else %}false{% endif %}">
      <strong>
        {% if tag == 'DLC' or tag == 'CCT' %}
          {{ tag }}
        {% else %}
          {{ tag | capitalize }}
        {% endif %}
      </strong>
      <span class="plus-button"></span>
    </div>

    {{ filter_list_markup }}
  </div>
{% endif %}
